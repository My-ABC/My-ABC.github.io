# .github/workflows/update-projects.yml
name: Auto Update Projects
on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Fetch ALL repositories
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          USERNAME: "My-ABC"  # ğŸ‘ˆ ä¿®æ”¹ä¸ºä½ çš„ç”¨æˆ·å
        run: |
          # å®‰è£…å¿…è¦å·¥å…·
          sudo apt-get install -y jq

          # 1. è·å–æ‰€æœ‰å…¬å¼€ä»“åº“åˆ—è¡¨
          echo "æ­£åœ¨è·å–ä»“åº“åˆ—è¡¨..."
          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USERNAME/repos?per_page=100" \
            > repos_raw.json

          # è°ƒè¯•ï¼šæ£€æŸ¥APIè¿”å›æ•°æ®
          echo "APIè¿”å›æ•°æ®ç¤ºä¾‹ï¼š"
          jq '.[0] | {name, full_name, stargazers_count}' repos_raw.json

          # 2. æå–ä»“åº“åç§°
          jq -r '.[].full_name' repos_raw.json > repos.txt
          echo "æ‰¾åˆ°çš„ä»“åº“ï¼š"
          cat repos.txt

          # 3. ä¸ºæ¯ä¸ªä»“åº“è·å–è¯¦ç»†æ•°æ®
          mkdir -p public/repos
          while read -r repo; do
            echo "æ­£åœ¨å¤„ç†ä»“åº“ï¼š$repo"
            curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$repo" > "public/repos/${repo//\//_}.json"
            
            # è°ƒè¯•ï¼šæ£€æŸ¥å•ä¸ªä»“åº“æ•°æ®
            echo "ä»“åº“æ•°æ®é¢„è§ˆï¼š"
            jq '{name, stargazers_count, language}' "public/repos/${repo//\//_}.json"
          done < repos.txt

          # 4. ç”Ÿæˆåˆå¹¶çš„JSONæ–‡ä»¶
          echo "æ­£åœ¨ç”Ÿæˆprojects.json..."
          jq -s '.' public/repos/*.json > public/projects.json

          # 5. æœ€ç»ˆéªŒè¯
          echo "ç”Ÿæˆçš„projects.jsonå†…å®¹é¢„è§ˆï¼š"
          jq '.[0] | {name, stargazers_count}' public/projects.json
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}