name: Auto Update Projects
on:
  schedule:
    - cron: '0 * * * *'  # 每小时整点运行
  workflow_dispatch:     # 手动触发
  push:                  # 代码推送时触发（可选）
    branches: [ main, master ]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          mkdir -p public/repos  # 确保目录存在

      - name: Fetch repositories
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          USERNAME: "My-ABC"
        run: |
          # 获取仓库列表（带重试机制）
          curl --retry 3 -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USERNAME/repos?per_page=100&sort=updated" \
            > repos_raw.json || echo "API请求失败"

          # 验证数据有效性
          if ! jq empty repos_raw.json; then
            echo "错误：无效的API响应"
            cat repos_raw.json
            exit 1
          fi

          # 处理数据
          jq -r '.[].full_name' repos_raw.json > repos.txt
          while read -r repo; do
            echo "Processing $repo..."
            curl --retry 2 -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$repo" > "public/repos/${repo//\//_}.json"
          done < repos.txt

          # 生成最终文件
          jq -s '.' public/repos/*.json > public/projects.json
          echo "生成结果："
          jq length public/projects.json